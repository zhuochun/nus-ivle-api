/*! NUS IVLE API JavaScript SDK - v0.1.0 - 2012-10-25
* https://github.com/Zhuochun/nus-ivle-api
* Copyright (c) 2012 Wang Zhuochun; Licensed MIT */
(function(e,t,n){"use strict";function a(e,t){this.KEY=e,this.TOKEN=t}function f(e,t){this._user=e,this._data=t,this._lastUpdate=new Date}var r="https://ivle.nus.edu.sg/api/",i=r+"lapi.svc/",s=function(t){return e.ajax({type:"GET",dataType:"jsonp",contentType:"application/x-javascript",url:t,xhrFields:{widthCredentials:!1}})},o=function(t,r,s,o){return i+s+"?APIKey="+t+(o===n?"&Token="+r:"&AuthToken="+r+"&"+decodeURIComponent(e.param(o)))+"&output=json"},u;typeof exports!="undefined"?u=exports:u=t.ivle={},u.VERSION="0.1.0",u.getToken=function(e){var n,r=/\?token=(\w+)/ig.exec(e||t.location.href);return r&&(n=r[1]),n},u.login=function(e,t){return r+"login/?apikey="+e+"&url="+encodeURIComponent(t)},u.User=function(e,t){return new a(e,t)},a.prototype={constructor:a,_get:function(e,t){return s(o(this.KEY,this.TOKEN,e,t))},_identity:function(e,t,n){var r=this;this[t]?n(this[t]):this._get(e).success(function(e){n(r[t]=e)})},validate:function(e){var t=this;this._get("Validate").success(function(n){n.Success&&n.Token!==t.TOKEN&&(t.TOKEN=n.Token),e(n.Success)})},id:function(e){this._identity("UserID_Get","_id",e)},name:function(e){this._identity("UserName_Get","_name",e)},email:function(e){this._identity("UserEmail_Get","_email",e)},Module:function(e){return new f(this,e)},modules:function(t,n){e.isFunction(t)&&(n=t,t={});var r=this,i=e.extend({Duration:10,IncludeAllInfo:!0},t);this._get("Modules",i).success(function(e){var t,i=[];if(e.Comments==="Valid login!")for(t in e.Results)i.push(new f(r,e.Results[t]));n(i)})},unreadAnnouncements:function(e){this._get("Announcements_Unread",{TitleOnly:!1}).success(e)},search:function(t,n,r){var i=e.extend({IncludeAllInfo:!0},n);t==="Modules"?this._get("Modules_Search",i).success(r):r(null)},download:function(e){var t=r+"downloadfile.ashx?APIKey="+this.KEY+"&AuthToken="+this.TOKEN+"&target=workbin&ID=";return typeof e=="string"?t+e:e.ID?t+e.ID:null}},f.prototype={constructor:f,get:function(e){return this._data[e]},update:function(){var e=this,t=0|(new Date-this._lastUpdate)/1e3/60;t>0&&this._user._get("Module",{Duration:t,IncludeAllInfo:!0,CourseID:e.get("ID"),TitleOnly:!1}).success(function(t){t.Comments==="Valid login!"&&(e._lastUpdate=new Date,e._data=t.Results[0])})},gradebook:function(e){var t=this;this._user._get("Gradebook_ViewItems",{CourseID:t.get("ID")}).success(function(t){t.Comments==="Valid login!"?e(t.Results):e(null)})}};var l,c="information weblinks readingFormatted readingUnformatted reading".split(" "),h=function(e){return function(t){var n=this;this._user._get("Module_"+e,{CourseID:n.get("ID")}).success(function(e){e.Comments==="Valid login!"?t(e.Results):t(null)})}};for(l in c)f.prototype[c[l]]=h(c[l]);var p=[{api:"announcements",options:{Duration:0,TitleOnly:!1}},{api:"workbins",options:{Duration:0,TitleOnly:!1}},{api:"forums",options:{Duration:0,IncludeThreads:!0,TitleOnly:!1}},{api:"webcasts",options:{Duration:0}}],d=function(t){return function(n,r){e.isFunction(n)&&(r=n,n={});var i=this,s=e.extend({CourseID:i.get("ID")},t.options,n);this._user._get(t.api,s).success(function(e){e.Comments==="Valid login!"&&r(e.Results)})}};for(l in p)f.prototype[p[l].api]=d(p[l])})(jQuery,window);