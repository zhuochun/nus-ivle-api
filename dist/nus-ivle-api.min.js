/*! NUS IVLE API JavaScript SDK - v0.2.0 - 2012-10-26
* https://github.com/Zhuochun/nus-ivle-api
* Copyright (c) 2012 Wang Zhuochun; Licensed MIT */
(function(e,t,n){"use strict";function f(e,t){this.KEY=e,this.TOKEN=t}function l(e,t){this._user=e,this._data=t,this._lastUpdate=new Date}var r="https://ivle.nus.edu.sg/api/",i=r+"lapi.svc/",s=function(t){return e.ajax({type:"GET",dataType:"jsonp",contentType:"application/x-javascript",url:t,xhrFields:{widthCredentials:!1}})},o=function(t,r,s,o){return i+s+"?APIKey="+t+(o===n?"&Token="+r:"&AuthToken="+r+"&"+decodeURIComponent(e.param(o)))+"&output=json"},u=function(e){return e.Comments==="Valid login!"||e.Comments===""?e.Results:null},a;typeof exports!="undefined"?a=exports:a=t.ivle={},a.VERSION="0.2.0",a.getToken=function(e){var n,r=/\?token=(\w+)/ig.exec(e||t.location.href);return r&&(n=r[1]),n},a.login=function(e,t){return r+"login/?apikey="+e+"&url="+encodeURIComponent(t)},a.User=function(e,t){return new f(e,t)},f.prototype={constructor:f,_get:function(e,t){return s(o(this.KEY,this.TOKEN,e,t))},_identity:function(e,t,n){var r=this;if(!this[t])return this._get(e).success(function(e){n(r[t]=e)});n(this[t])},validate:function(e){var t=this;return this._get("Validate").success(function(n){n.Success&&n.Token!==t.TOKEN&&(t.TOKEN=n.Token),e(n.Success)})},id:function(e){this._identity("UserID_Get","_id",e)},name:function(e){this._identity("UserName_Get","_name",e)},email:function(e){this._identity("UserEmail_Get","_email",e)},Module:function(e){return new l(this,e)},modules:function(t,n){e.isFunction(t)&&(n=t,t={});var r=this,i=e.extend({Duration:0,IncludeAllInfo:!0},t);this._get("Modules",i).success(function(e){var t,i=[],s=u(e);if(s){for(t in s)i.push(new l(r,s[t]));n(i)}else n(s)})},unreadAnnouncements:function(e){this._get("Announcements_Unread",{TitleOnly:!1}).success(function(t){e(u(t))})},search:function(t,n,r){var i=e.extend({IncludeAllInfo:!0},n);t==="Modules"?this._get("Modules_Search",i).success(function(e){r(u(e))}):r(null)},download:function(e){var t=r+"downloadfile.ashx?APIKey="+this.KEY+"&AuthToken="+this.TOKEN+"&target=workbin&ID=";return typeof e=="string"?t+e:e.ID?t+e.ID:null}},l.prototype={constructor:l,get:function(e){return this._data[e]},update:function(){var e=this;this._user._get("Module",{Duration:0,IncludeAllInfo:!0,CourseID:e.get("ID"),TitleOnly:!1}).success(function(t){var n=u(t);n&&n.length>0&&(e._lastUpdate=new Date,e._data=t.Results[0])})},gradebooksAsync:function(e){var t=this;this._user._get("Gradebook_ViewItems",{CourseID:t.get("ID")}).success(function(t){e(u(t))})}};var c="announcements forums workbins webcasts gradebooks polls webLinks lecturers descriptions".split(" "),h=function(e){return e.slice(0,1).toUpperCase()+e.slice(1)},p,d=function(e){return function(){return this.get(e)}};for(p in c)l.prototype[c[p].toLowerCase()]=d.apply(l.prototype,[h(c[p])]);var v=[{api:"announcements",options:{Duration:0,TitleOnly:!1}},{api:"workbins",options:{Duration:0,TitleOnly:!1,WorkbinID:""}},{api:"forums",options:{Duration:0,IncludeThreads:!0,TitleOnly:!1}},{api:"webcasts",options:{Duration:0}}],m=function(t){return function(n,r){e.isFunction(n)&&(r=n,n={});var i=this,s=e.extend({CourseID:i.get("ID")},t.options,n);this._user._get(h(t.api),s).success(function(e){r(u(e))})}};for(p in v)l.prototype[v[p].api+"Async"]=m.apply(l.prototype,[v[p]])})(jQuery,window);